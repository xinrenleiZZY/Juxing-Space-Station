# LSTM-PM2.5预测分析系统 - 文件详细说明

## 📁 项目概述

本项目是一个完整的LSTM（长短期记忆网络）-PM2.5预测分析系统，用于预测华北地区13个城市的PM2.5日级浓度。系统包含完整的数据预处理、模型构建、训练、评估和可视化流程，并提供直观的命令行接口进行控制。

**项目核心价值**：
- 提供完整的时间序列预测解决方案
- 支持城市级别的PM2.5浓度预测
- 包含丰富的数据分析和可视化功能
- 提供便捷的命令行控制接口

## 📂 目录结构

```
lstm_analysis/
├── configs/                    # 配置文件
├── data_preparation/           # 原始数据
├── data_processing/            # 数据处理模块
├── model_building/             # 模型构建模块
├── model_evaluation/           # 模型评估模块
├── model_training/             # 模型训练模块
├── results/                    # 结果文件
├── utils/                      # 工具函数
├── visualization/              # 可视化结果
├── cli.py                      # 命令行接口
├── dashboard.py                # 可视化大屏入口
├── visualization_dashboard.py  # 可视化大屏主脚本
├── README.md                   # 项目说明文档
├── FILE_DESCRIPTION.md         # 本文件 - 文件详细说明
├── requirements.txt            # 依赖列表
```

## 🔧 配置文件 (configs/)

### config.py
**作用**：项目核心配置文件，集中管理所有关键参数，实现参数与代码的分离

**已实现功能**：
- 定义数据路径和结果文件路径
- 配置模型架构参数
- 定义特征工程和数据处理参数
- 设置训练/验证/测试集比例
- 提供可扩展的配置结构

**核心参数说明**：

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `TIME_STEPS` | int | 7 | 时间窗口大小（使用前7天数据预测第8天） |
| `LSTM_UNITS_1` | int | 64 | 第一层LSTM神经元数量 |
| `LSTM_UNITS_2` | int | 32 | 第二层LSTM神经元数量 |
| `DROPOUT_RATE` | float | 0.2 | Dropout正则化率，防止过拟合 |
| `BATCH_SIZE` | int | 32 | 训练批次大小 |
| `EPOCHS` | int | 50 | 最大训练轮数 |
| `LEARNING_RATE` | float | 0.001 | 学习率 |
| `TRAIN_RATIO` | float | 0.7 | 训练集比例 |
| `VAL_RATIO` | float | 0.15 | 验证集比例 |
| `TEST_RATIO` | float | 0.15 | 测试集比例 |
| `TARGET_COL` | str | "PM2.5" | 预测目标列 |
| `FEATURE_COLS` | list | ["AQI", "PM2.5", "year", ...] | 特征列列表 |

**使用方法**：
```python
from configs.config import *
# 直接使用配置参数
model = build_lstm_model(LSTM_UNITS_1, LSTM_UNITS_2, DROPOUT_RATE)
```

### data_config.py
**作用**：专门用于数据预处理和特征工程的配置文件

**已实现功能**：
- 定义数据清洗规则
- 配置特征工程参数
- 设置时间特征提取规则
- 定义数据标准化方法

**关键配置**：
- 滞后特征窗口：1-3天
- 滚动特征窗口：3-7天
- 数据标准化方法：MinMaxScaler
- 日期特征：年、月、日、星期几、季度

## 📊 数据准备 (data_preparation/)

### 20260119_150028_LstmData.csv
**作用**：系统使用的原始空气质量数据文件

**数据特点**：
- **来源**：华北地区空气质量监测站
- **覆盖范围**：13个城市（保定、北京、唐山、天津、廊坊、张家口、承德、沧州、石家庄、秦皇岛、衡水、邢台、邯郸）
- **时间跨度**：2015-01-07 至 2026-01-19（约11年数据）
- **数据量**：106,229条记录
- **特征维度**：11列（日期、城市、AQI、PM2.5、PM10、O3、NO2、SO2、CO、温度、湿度）

**数据格式**：
| 日期 | 城市 | AQI | PM2.5 | PM10 | O3 | NO2 | SO2 | CO | 温度 | 湿度 |
|------|------|-----|-------|------|----|-----|-----|----|------|------|
| 2015-01-07 | 保定 | 156 | 116 | 176 | 4 | 58 | 35 | 3.2 | -5 | 45 |

## 🧹 数据处理 (data_processing/)

### data_processing.py
**作用**：完整的数据预处理主脚本，实现从原始数据到模型可接受格式的转换

**已实现功能**：
1. **数据加载与清洗**：
   - 加载原始CSV数据
   - 处理缺失值（插值或删除）
   - 数据类型转换和格式标准化

2. **特征工程**：
   - 时间特征提取（年、月、日、星期几、季度）
   - 滞后特征（前1-3天的PM2.5值）
   - 滚动特征（3-7天的移动平均、标准差）
   - 统计特征（最大值、最小值、极差）

3. **数据归一化**：
   - 使用MinMaxScaler进行特征缩放
   - 保存缩放器供后续使用

4. **时间序列划分**：
   - 按时间顺序划分训练集、验证集和测试集
   - 确保样本的时间连续性

5. **滑动窗口构建**：
   - 为LSTM模型创建时间序列样本
   - 每个样本包含TIME_STEPS天的数据

**关键函数详解**：

```python
def load_and_clean_data(file_path):
    """
    加载并清洗原始数据
    参数：file_path - 数据文件路径
    返回：清洗后的DataFrame
    """
    # 实现数据加载、缺失值处理、异常值检测等


def create_features(data, target_col, feature_cols):
    """
    创建特征工程
    参数：
        data - 输入数据
        target_col - 目标列名
        feature_cols - 基础特征列
    返回：包含新特征的DataFrame
    """
    # 实现时间特征、滞后特征、滚动特征的创建


def create_sequences(data, time_steps):
    """
    创建时间序列样本
    参数：
        data - 预处理后的数据
        time_steps - 时间窗口大小
    返回：(X, y) - 特征和标签的numpy数组
    """
    # 实现滑动窗口构建逻辑
```

**输出结果**：
- 预处理后的CSV文件
- 训练/验证/测试集划分
- 标准化后的numpy数组
- 保存的缩放器对象

## 🤖 模型构建 (model_building/)

### lstm_model.py
**作用**：LSTM模型架构定义文件，实现模型的构建和编译

**已实现功能**：
- 定义双层LSTM模型架构
- 实现模型编译逻辑
- 支持自定义参数配置
- 提供模型结构可视化

**模型设计思路**：
- 采用双层LSTM结构，捕获不同时间尺度的特征
- 使用Dropout层防止过拟合
- 输出层使用线性激活函数，适合回归任务

**详细模型结构**：
```
Layer (type)                 Output Shape              Param #
=================================================================
lstm_input (InputLayer)      [(None, 7, 11)]           0
_________________________________________________________________
lstm_1 (LSTM)                (None, 7, 64)             19200
_________________________________________________________________
dropout_1 (Dropout)          (None, 7, 64)             0
_________________________________________________________________
lstm_2 (LSTM)                (None, 32)                12416
_________________________________________________________________
dropout_2 (Dropout)          (None, 32)                0
_________________________________________________________________
dense_output (Dense)         (None, 1)                 33
=================================================================
Total params: 31,649
Trainable params: 31,649
Non-trainable params: 0
```

**关键函数**：
```python
def build_lstm_model(lstm_units_1, lstm_units_2, dropout_rate, learning_rate):
    """
    构建LSTM模型
    参数：
        lstm_units_1 - 第一层LSTM单元数
        lstm_units_2 - 第二层LSTM单元数
        dropout_rate - Dropout率
        learning_rate - 学习率
    返回：编译好的Keras模型
    """
    # 实现模型构建和编译
```

## 🏋️‍♂️ 模型训练 (model_training/)

### train_model.py
**作用**：模型训练脚本，负责执行完整的模型训练流程

**已实现功能**：
1. **数据准备**：
   - 加载预处理后的数据
   - 加载数据缩放器

2. **模型加载**：
   - 加载预定义的LSTM模型架构
   - 配置训练参数

3. **训练过程**：
   - 使用训练集进行模型训练
   - 使用验证集监控性能
   - 实现早停机制防止过拟合
   - 保存训练历史记录

4. **模型保存**：
   - 保存最佳模型权重
   - 保存完整模型结构

**训练策略**：
- 使用Adam优化器进行梯度下降
- 损失函数：均方误差(MSE)
- 早停条件：验证集损失3轮不下降则停止
- 模型检查点：保存验证集损失最小的模型

**输出结果**：
- 训练好的模型文件 (.h5)
- 训练历史记录
- 训练过程可视化图表

## 📈 模型评估 (model_evaluation/)

### evaluate_model.py
**作用**：模型评估脚本，负责在测试集上评估模型性能

**已实现功能**：
1. **模型加载**：
   - 加载训练好的LSTM模型
   - 加载数据缩放器

2. **预测过程**：
   - 使用测试集进行预测
   - 反缩放预测结果

3. **性能评估**：
   - 计算多种评估指标
   - 生成评估报告

4. **结果保存**：
   - 保存预测结果
   - 保存评估指标

**评估指标详解**：
- **MSE (Mean Squared Error)**：均方误差，反映预测值与真实值的平均平方差
- **RMSE (Root Mean Squared Error)**：均方根误差，MSE的平方根，与目标变量单位相同
- **MAE (Mean Absolute Error)**：平均绝对误差，反映预测值与真实值的平均绝对差
- **R² (Coefficient of Determination)**：决定系数，衡量模型对数据的解释能力

**输出结果**：
- 预测结果CSV文件
- 评估指标报告
- 误差分析图表

## 🎨 可视化 (visualization/)

### plot_results.py
**作用**：结果可视化脚本，生成各种分析图表

**已实现功能**：
- 绘制预测值与真实值的时间序列对比图
- 绘制预测误差的分布直方图
- 绘制真实值与预测值的散点图
- 生成训练历史可视化（损失曲线）
- 支持图表保存和导出

**图表类型**：
1. **时间序列对比图**：展示预测值和真实值随时间的变化
2. **误差分布直方图**：展示预测误差的频率分布
3. **散点图**：评估预测值与真实值的线性关系
4. **损失曲线**：展示训练过程中损失的变化

### error_analysis.png
**作用**：预测误差分析图，直观展示模型的预测误差分布

**图表内容**：
- X轴：预测误差值
- Y轴：误差出现的频率
- 包含均值、标准差、最大值、最小值等统计信息
- 帮助分析模型的稳定性和偏差

### prediction_comparison.png
**作用**：预测值与真实值对比图，展示模型在测试集上的表现

**图表特点**：
- 两条曲线：蓝色代表真实值，红色代表预测值
- 清晰展示预测的准确性和趋势捕捉能力
- 包含时间轴和数值轴

## 🛠️ 工具函数 (utils/)

### data_utils.py
**作用**：数据处理工具函数集，提供通用的数据处理功能

**已实现功能**：
- **数据加载与保存**：支持CSV、NPZ、PKL等格式
- **特征选择**：基于相关性的特征筛选
- **数据转换**：时间序列转换和重塑
- **缺失值处理**：多种插值和填充方法
- **异常值检测**：基于统计的异常值识别

**核心函数**：
```python
def save_data(data, file_path, format="csv"):
    """保存数据到文件"""

def load_data(file_path, format="csv"):
    """从文件加载数据"""

def detect_outliers(data, column):
    """检测异常值"""
```

### plot_utils.py
**作用**：可视化工具函数集，提供通用的图表绘制功能

**已实现功能**：
- **图表样式配置**：统一的颜色方案和样式
- **时间序列图**：绘制时间序列数据
- **散点图**：绘制相关性散点图
- **直方图**：绘制数据分布直方图
- **热力图**：绘制特征相关性热力图

**核心函数**：
```python
def plot_time_series(x, y1, y2, label1="真实值", label2="预测值", title="时间序列对比"):
    """绘制时间序列对比图"""

def plot_error_distribution(errors, title="误差分布"):
    """绘制误差分布直方图"""

def plot_correlation_heatmap(data, title="特征相关性热力图"):
    """绘制特征相关性热力图"""
```

## 🎯 命令行接口 (cli.py)
**作用**：项目的命令行控制中心，提供便捷的终端命令操作

**已实现命令**：

| 命令 | 作用 | 参数 | 示例 |
|------|------|------|------|
| `preprocess` | 运行数据预处理 | `--city` - 城市名<br>`--input` - 输入目录 | `python cli.py preprocess --city 北京` |
| `train` | 训练LSTM模型 | - | `python cli.py train` |
| `evaluate` | 评估模型性能 | - | `python cli.py evaluate` |
| `dashboard` | 启动可视化大屏 | `--port` - 端口号 | `python cli.py dashboard --port 8502` |
| `run_all` | 一键运行完整流程 | `--city` - 城市名 | `python cli.py run_all` |
| `config` | 查看配置信息 | - | `python cli.py config` |
| `data` | 查看数据概览 | - | `python cli.py data` |
| `clean` | 清除结果文件 | `--all` - 清除所有 | `python cli.py clean --all` |

**命令设计特点**：
- 清晰的命令语义
- 丰富的参数支持
- 详细的帮助信息
- 一致的输出格式
- 友好的错误提示

## 📊 可视化大屏 (dashboard.py)
**作用**：可视化大屏的入口文件，提供便捷的启动方式

**已实现功能**：
- 检查运行环境
- 验证依赖包
- 启动Streamlit应用
- 提供应用状态反馈

**使用方式**：
```bash
python dashboard.py
```

## 🎨 可视化大屏主脚本 (visualization_dashboard.py)
**作用**：完整的Streamlit可视化应用，提供交互式数据分析界面

**已实现模块**：

1. **数据概览模块**：
   - 显示总数据量和覆盖范围
   - 展示城市列表和数据统计
   - 显示日期范围和数据分布

2. **数据质量分析模块**：
   - 缺失值分析热力图
   - 异常值检测结果
   - 数据完整性报告

3. **特征工程可视化模块**：
   - 时间特征分布
   - 滞后特征相关性
   - 滚动特征效果

4. **月度趋势分析模块**：
   - 各城市月度平均PM2.5趋势
   - 季节性变化分析
   - 城市间对比

5. **模型性能展示模块**：
   - 模型架构可视化
   - 评估指标展示
   - 训练历史可视化

6. **预测结果对比模块**：
   - 预测值与真实值时间序列对比
   - 可调整显示天数（7-90天）
   - 城市间预测效果对比

7. **误差分析模块**：
   - 误差分布直方图
   - 真实值vs预测值散点图
   - 误差随时间变化趋势

8. **特征相关性分析模块**：
   - 特征相关性热力图
   - 重要特征排序
   - 特征影响力分析

**交互功能**：
- 城市选择器
- 时间范围滑块
- 图表放大缩小
- 数据导出功能
- 配置参数调整

## 💾 结果文件 (results/)

### full_preprocessed_data.csv
**作用**：完整的预处理后数据，包含所有特征

**文件特点**：
- 格式：CSV
- 大小：约3.39 MB
- 记录数：51,644条
- 包含所有特征列和目标列

### predictions.csv
**作用**：模型预测结果文件

**文件内容**：
- 日期
- 真实PM2.5值
- 预测PM2.5值
- 预测误差

### preprocessed_data.npz
**作用**：为LSTM模型准备的numpy数组数据

**文件内容**：
- X_train: 训练集特征
- y_train: 训练集标签
- X_val: 验证集特征
- y_val: 验证集标签
- X_test: 测试集特征
- y_test: 测试集标签

### scaler.pkl
**作用**：数据标准化缩放器对象

**作用**：
- 用于特征缩放和反缩放
- 保存训练数据的缩放参数
- 确保预测时使用相同的缩放规则

### test_data.csv
**作用**：测试集数据

**文件特点**：
- 格式：CSV
- 大小：约0.04 MB
- 包含测试集的所有特征和标签

### trained_model.h5
**作用**：训练好的LSTM模型文件

**文件内容**：
- 完整的模型结构
- 训练好的权重参数
- 模型配置信息

**使用方式**：
```python
from tensorflow.keras.models import load_model
model = load_model('trained_model.h5')
```

### train_data.csv / val_data.csv
**作用**：训练集和验证集数据

**文件特点**：
- 格式：CSV
- 大小：训练集约0.18 MB，验证集约0.04 MB
- 包含相应数据集的所有特征和标签

## 📋 依赖列表 (requirements.txt)
**作用**：项目依赖包列表，确保环境一致性

**依赖分类**：

1. **核心依赖**：
   - pandas: 数据处理和分析
   - numpy: 数值计算
   - tensorflow: 深度学习框架
   - scikit-learn: 机器学习工具

2. **可视化依赖**：
   - streamlit: 交互式Web应用框架
   - matplotlib: 绘图库
   - seaborn: 统计可视化库

3. **工具依赖**：
   - joblib: 模型和数据序列化
   - tqdm: 进度条显示

**安装方式**：
```bash
pip install -r requirements.txt
```

## 🎯 总结

本项目是一个功能完整、架构清晰的LSTM-PM2.5预测分析系统，具有以下特点：

1. **完整的数据处理流程**：
   - 从原始数据到模型可接受格式的完整转换
   - 丰富的特征工程技术
   - 标准化的数据处理流程

2. **强大的LSTM模型**：
   - 双层LSTM架构，捕获复杂的时间模式
   - 灵活的参数配置
   - 完善的训练和评估流程

3. **全面的评估体系**：
   - 多种评估指标
   - 详细的结果分析
   - 可视化的评估报告

4. **直观的可视化界面**：
   - 交互式的Streamlit大屏
   - 丰富的图表和分析工具
   - 便捷的数据探索功能

5. **便捷的命令行控制**：
   - 8种命令支持
   - 丰富的参数选项
   - 友好的用户体验

6. **良好的可扩展性**：
   - 模块化设计
   - 清晰的接口定义
   - 可扩展的配置结构

该系统不仅可以用于PM2.5预测，还可以作为时间序列预测的通用框架，通过简单的配置修改即可应用于其他时间序列预测任务。